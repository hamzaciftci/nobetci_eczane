name: Ingestion Cron

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: ingestion-cron
  cancel-in-progress: false

jobs:
  trigger-hourly-ingest:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Trigger sharded ingestion endpoint
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          CRON_INGEST_URL: ${{ secrets.CRON_INGEST_URL }}
        run: |
          set -euo pipefail
          TOKEN="${CRON_TOKEN:-${CRON_SECRET:-}}"
          if [ -z "${TOKEN}" ]; then
            echo "CRON_TOKEN (or CRON_SECRET) GitHub secret is required."
            exit 1
          fi

          URL="${CRON_INGEST_URL:-https://www.bugunnobetcieczaneler.com/api/cron/ingest}"
          SHARD_COUNT=4
          for SHARD_INDEX in 0 1 2 3; do
            SHARD_URL="${URL}?shard_index=${SHARD_INDEX}&shard_count=${SHARD_COUNT}"
            echo "Triggering: ${SHARD_URL}"
            HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" \
              -H "Authorization: Bearer ${TOKEN}" \
              -H "x-cron-token: ${TOKEN}" \
              "$SHARD_URL")
            cat response.json
            echo
            if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
              echo "Shard ${SHARD_INDEX}/${SHARD_COUNT} failed with HTTP $HTTP_CODE"
              exit 1
            fi
          done
